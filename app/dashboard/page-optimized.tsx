"use client";

import React, { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import dynamic from 'next/dynamic';
import { 
  Layout, 
  Spin, 
  Alert, 
  notification, 
  Button, 
  Modal, 
  Form, 
  Input, 
  Select, 
  DatePicker, 
  Switch,
  Card,
  Space,
  Typography,
  Row,
  Col
} from 'antd';
import { 
  PlusOutlined, 
  BellOutlined, 
  WarningOutlined,
  FireOutlined,
  ThunderboltOutlined,
  ExperimentOutlined
} from '@ant-design/icons';
import { emergencyApi, EarthquakeData } from '@/app/services/emergencyApi';

// Tsunami verileri i√ßin interface
export interface TsunamiData {
  id: string;
  eventId: string;
  source: string;
  date: string;
  latitude: number;
  longitude: number;
  waveHeight: number;
  location: string;
  alert: boolean;
}
import dayjs from 'dayjs';

const { Content } = Layout;
const { Title } = Typography;
const { Option } = Select;
const { TextArea } = Input;

// üöÄ Dynamic Imports - Lazy Loading i√ßin Optimize Edilmi≈ü Component'ler
const DashboardStats = dynamic(
  () => import('./components/DashboardStats'),
  { 
    ssr: false,
    loading: () => <div style={{ height: '200px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}><Spin size="large" /></div>
  }
);

const DashboardMap = dynamic(
  () => import('./components/DashboardMap'),
  { 
    ssr: false,
    loading: () => <div style={{ height: '400px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}><Spin size="large" /></div>
  }
);

const DashboardTasks = dynamic(
  () => import('./components/DashboardTasks'),
  { 
    ssr: false,
    loading: () => <div style={{ height: '300px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}><Spin size="large" /></div>
  }
);

const DashboardUsers = dynamic(
  () => import('./components/DashboardUsers'),
  { 
    ssr: false,
    loading: () => <div style={{ height: '400px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}><Spin size="large" /></div>
  }
);

const DashboardChat = dynamic(
  () => import('./components/DashboardChat'),
  { 
    ssr: false,
    loading: () => <div style={{ height: '300px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}><Spin size="large" /></div>
  }
);

const DashboardNotifications = dynamic(
  () => import('./components/DashboardNotifications'),
  { 
    ssr: false,
    loading: () => <div style={{ height: '300px', display: 'flex', justifyContent: 'center', alignItems: 'center' }}><Spin size="large" /></div>
  }
);

// Acil durum t√ºrleri
const emergencyTypes = [
  { value: 'earthquake', label: 'Deprem', icon: <ThunderboltOutlined />, color: '#ff4d4f' },
  { value: 'fire', label: 'Yangƒ±n', icon: <FireOutlined />, color: '#fa541c' },
  { value: 'flood', label: 'Sel', icon: <WarningOutlined />, color: '#1890ff' },
  { value: 'storm', label: 'Fƒ±rtƒ±na', icon: <WarningOutlined />, color: '#722ed1' },
  { value: 'exercise', label: 'Tatbikat', icon: <ExperimentOutlined />, color: '#52c41a' },
  { value: 'other', label: 'Diƒüer', icon: <BellOutlined />, color: '#faad14' }
];

// Kullanƒ±cƒ± hedef gruplarƒ±
const targetGroups = [
  { value: 'all', label: 'T√ºm Kullanƒ±cƒ±lar' },
  { value: 'staff', label: 'Sadece Personel' },
  { value: 'volunteers', label: 'Sadece G√∂n√ºll√ºler' },
  { value: 'managers', label: 'Sadece Y√∂neticiler' },
  { value: 'regional', label: 'B√∂lge Kullanƒ±cƒ±larƒ±' },
  { value: 'emergency_teams', label: 'Acil Durum Ekipleri' }
];

const Dashboard: React.FC = () => {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [userRole, setUserRole] = useState<string>('');
  const [recentEarthquakes, setRecentEarthquakes] = useState<EarthquakeData[]>([]);
  const [recentTsunamis, setRecentTsunamis] = useState<TsunamiData[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [wsConnected, setWsConnected] = useState(false);
  
  // Bildirim modal state'leri
  const [isNotificationModalVisible, setIsNotificationModalVisible] = useState(false);
  const [notificationForm] = Form.useForm();
  const [submittingNotification, setSubmittingNotification] = useState(false);
  
  useEffect(() => {
    // Kullanƒ±cƒ± oturumu y√ºklendiƒüinde rol√ºn√º ayarla
    if (session?.user?.role) {
      setUserRole(session.user.role as string);
    }
  }, [session]);
  
  useEffect(() => {
    const fetchRecentData = async () => {
      try {
        setLoading(true);
        setError(null);

        // Cache'den deprem verilerini getir
        const earthquakeData = await emergencyApi.getEarthquakesFromCache();
        
        // Son 24 saatteki depremleri filtrele
        const endDate = new Date();
        const startDate = new Date(endDate.getTime() - 24 * 60 * 60 * 1000);
        
        const recentEarthquakes = earthquakeData.filter(eq => {
          const eqDate = new Date(eq.date);
          return eqDate >= startDate && eqDate <= endDate && eq.magnitude >= 4.0;
        });

        setRecentEarthquakes(recentEarthquakes);
        
        // Tsunami verileri i√ßin demo data (hen√ºz cache'de yok)
        setRecentTsunamis([]);
        
        console.log(`Dashboard: ${recentEarthquakes.length} son deprem verisi y√ºklendi`);
      } catch (error) {
        console.error('Veri alƒ±nƒ±rken hata:', error);
        setError('Veriler alƒ±nƒ±rken bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.');
      } finally {
        setLoading(false);
      }
    };

    fetchRecentData();

    // WebSocket baƒülantƒ±sƒ± yerine periyodik g√ºncelleme
    const interval = setInterval(() => {
      fetchRecentData();
    }, 5 * 60 * 1000); // 5 dakikada bir g√ºncelle

    return () => {
      clearInterval(interval);
    };
  }, []);

  // Bildirim g√∂nderme fonksiyonu
  const handleNotificationSubmit = async (values: any) => {
    try {
      setSubmittingNotification(true);
      
      const notificationData = {
        title: values.title,
        description: values.description,
        type: values.severity,
        source: 'SYSTEM',
        emergencyType: values.emergencyType,
        targetGroup: values.targetGroup,
        location: values.location,
        coordinates: values.coordinates,
        urgent: values.urgent || false,
        scheduledAt: values.scheduledAt ? values.scheduledAt.toISOString() : null,
        expiresAt: values.expiresAt ? values.expiresAt.toISOString() : null,
        createdBy: session?.user?.id,
        createdAt: new Date().toISOString()
      };

      // API'ye bildirim g√∂nder
      const response = await fetch('/api/notifications', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(notificationData)
      });

      if (response.ok) {
        notification.success({
          message: 'Bildirim G√∂nderildi',
          description: 'Acil durum bildirimi ba≈üarƒ±yla olu≈üturuldu ve hedef kullanƒ±cƒ±lara g√∂nderildi.',
          placement: 'topRight'
        });
        
        setIsNotificationModalVisible(false);
        notificationForm.resetFields();
      } else {
        throw new Error('Bildirim g√∂nderilemedi');
      }
    } catch (error) {
      console.error('Bildirim g√∂nderme hatasƒ±:', error);
      notification.error({
        message: 'Hata',
        description: 'Bildirim g√∂nderilirken bir hata olu≈ütu. L√ºtfen tekrar deneyin.',
        placement: 'topRight'
      });
    } finally {
      setSubmittingNotification(false);
    }
  };
  
  // Oturum y√ºkleniyor durumu
  if (status === "loading") {
    return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
      <Spin size="large">
        <div style={{ padding: '20px' }}>Y√ºkleniyor...</div>
      </Spin>
    </div>;
  }
  
  // Kullanƒ±cƒ± oturumu kontrol et
  if (status === "unauthenticated") {
    router.push('/auth/login');
    return null;
  }
  
  // Kullanƒ±cƒ± bilgisi
  const user = session?.user;
  const userRegion = user?.regions?.[0] || '';
  
  // Hata durumunda uyarƒ± g√∂ster
  if (error) {
    return (
      <Content style={{ padding: '24px' }}>
        <Alert
          message="Veri Y√ºkleme Hatasƒ±"
          description={error}
          type="error"
          showIcon
          action={
            <button onClick={() => window.location.reload()}>
              Sayfayƒ± Yenile
            </button>
          }
        />
      </Content>
    );
  }

  return (
    <Content style={{ padding: '24px', background: '#f5f5f5' }}>
      <div style={{ display: 'grid', gap: '24px' }}>
        {/* Ba≈ülƒ±k ve Bildirim Ekle Butonu */}
        <Card>
          <Row justify="space-between" align="middle">
            <Col>
              <Title level={2} style={{ margin: 0 }}>
                Kontrol Paneli
              </Title>
              <p style={{ margin: 0, color: '#666' }}>
                Ho≈ü geldiniz, {user?.name} ‚Ä¢ {userRole === 'admin' ? 'Sistem Y√∂neticisi' : 
                              userRole === 'regional_manager' ? 'B√∂lge Y√∂neticisi' :
                              userRole === 'manager' ? 'Kurum Y√∂neticisi' :
                              userRole === 'staff' ? 'Personel' :
                              userRole === 'volunteer' ? 'G√∂n√ºll√º' : 'Kullanƒ±cƒ±'}
              </p>
            </Col>
            <Col>
              <Space>
                <Button 
                  type="primary" 
                  icon={<PlusOutlined />}
                  onClick={() => setIsNotificationModalVisible(true)}
                  size="large"
                >
                  Bildirim Ekle
                </Button>
              </Space>
            </Col>
          </Row>
        </Card>

        {/* üìä ƒ∞statistikler - Lazy Loaded */}
        <DashboardStats userRole={userRole} />
        
        {/* üó∫Ô∏è Harita & Aktif Kullanƒ±cƒ±lar - Grid Layout */}
        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '24px' }}>
          <DashboardMap 
            earthquakes={recentEarthquakes}
            tsunamis={recentTsunamis}
            loading={loading}
            wsConnected={wsConnected}
          />
          <DashboardUsers userRole={userRole} />
        </div>
        
        {/* üìã G√∂revler, Bildirimler & Chat - Grid Layout */}
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '24px' }}>
          <DashboardTasks userRole={userRole} />
          <DashboardNotifications limit={5} />
          <DashboardChat userRole={userRole} />
        </div>
      </div>

      {/* Bildirim Ekleme Modal'ƒ± */}
      <Modal
        title={
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
            <BellOutlined />
            Yeni Acil Durum Bildirimi
          </div>
        }
        open={isNotificationModalVisible}
        onCancel={() => {
          setIsNotificationModalVisible(false);
          notificationForm.resetFields();
        }}
        footer={null}
        width={800}
      >
        <Form
          form={notificationForm}
          layout="vertical"
          onFinish={handleNotificationSubmit}
        >
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="emergencyType"
                label="Acil Durum T√ºr√º"
                rules={[{ required: true, message: 'Acil durum t√ºr√º se√ßin' }]}
              >
                <Select placeholder="Acil durum t√ºr√º se√ßin">
                  {emergencyTypes.map(type => (
                    <Option key={type.value} value={type.value}>
                      <Space>
                        {type.icon}
                        {type.label}
                      </Space>
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="severity"
                label="√ñnem Derecesi"
                rules={[{ required: true, message: '√ñnem derecesi se√ßin' }]}
              >
                <Select placeholder="√ñnem derecesi se√ßin">
                  <Option value="error">üî¥ Kritik</Option>
                  <Option value="warning">üü° Uyarƒ±</Option>
                  <Option value="info">üîµ Bilgi</Option>
                  <Option value="success">üü¢ Ba≈üarƒ±lƒ±</Option>
                </Select>
              </Form.Item>
            </Col>
          </Row>

          <Form.Item
            name="title"
            label="Bildirim Ba≈ülƒ±ƒüƒ±"
            rules={[{ required: true, message: 'Bildirim ba≈ülƒ±ƒüƒ± girin' }]}
          >
            <Input placeholder="√ñrn: Kayseri'de 4.2 b√ºy√ºkl√ºƒü√ºnde deprem" />
          </Form.Item>

          <Form.Item
            name="description"
            label="Bildirim A√ßƒ±klamasƒ±"
            rules={[{ required: true, message: 'Bildirim a√ßƒ±klamasƒ± girin' }]}
          >
            <TextArea 
              rows={4} 
              placeholder="Detaylƒ± bildirim a√ßƒ±klamasƒ±..."
            />
          </Form.Item>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="location"
                label="Konum"
                rules={[{ required: true, message: 'Konum bilgisi girin' }]}
              >
                <Input placeholder="√ñrn: Kayseri, T√ºrkiye" />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="coordinates"
                label="Koordinatlar (Opsiyonel)"
              >
                <Input placeholder="√ñrn: 38.7437, 35.4781" />
              </Form.Item>
            </Col>
          </Row>

          <Form.Item
            name="targetGroup"
            label="Hedef Kullanƒ±cƒ± Grubu"
            rules={[{ required: true, message: 'Hedef grup se√ßin' }]}
          >
            <Select placeholder="Bildirim g√∂nderilecek kullanƒ±cƒ± grubu">
              {targetGroups.map(group => (
                <Option key={group.value} value={group.value}>
                  {group.label}
                </Option>
              ))}
            </Select>
          </Form.Item>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="scheduledAt"
                label="Zamanlanmƒ±≈ü G√∂nderim (Opsiyonel)"
              >
                <DatePicker 
                  showTime 
                  placeholder="G√∂nderim zamanƒ± se√ßin"
                  style={{ width: '100%' }}
                />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="expiresAt"
                label="Son Ge√ßerlilik Tarihi (Opsiyonel)"
              >
                <DatePicker 
                  showTime 
                  placeholder="Ge√ßerlilik sonu"
                  style={{ width: '100%' }}
                />
              </Form.Item>
            </Col>
          </Row>

          <Form.Item
            name="urgent"
            label="Acil Bildirim"
            valuePropName="checked"
          >
            <Switch />
          </Form.Item>

          <Form.Item style={{ marginBottom: 0, textAlign: 'right' }}>
            <Space>
              <Button onClick={() => setIsNotificationModalVisible(false)}>
                ƒ∞ptal
              </Button>
              <Button 
                type="primary" 
                htmlType="submit"
                loading={submittingNotification}
              >
                Bildirim G√∂nder
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>
    </Content>
  );
};

export default Dashboard; 